# L4:è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (vfs)

## 1. èƒŒæ™¯

åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬åœ¨å¤šå¤„ç†å™¨åˆ†æ—¶å¤šçº¿ç¨‹çš„åŸºç¡€ä¸Šå®ç°**çº¿ç¨‹å®‰å…¨**çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (virtual file system, VFS) APIï¼Œå¹¶ä¸”åœ¨ VFS è¿™ä¸€æŠ½è±¡å±‚ä¸Šå®ç°è‹¥å¹²ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼š

- åœ¨å­˜å‚¨è®¾å¤‡ (`sda`) ä¸Šæ”¯æŒå®Œæ•´æ–‡ä»¶å’Œç›®å½•æ“ä½œçš„æ–‡ä»¶ç³»ç»Ÿ â€œultra-simple file systemâ€ (ufs);
- è™šæ‹Ÿçš„ procfsï¼Œæä¾›ä¸€ç³»åˆ—åªè¯»çš„ã€åæ˜ æ“ä½œç³»ç»Ÿå†…éƒ¨çŠ¶æ€çš„æ–‡ä»¶ï¼›
- è™šæ‹Ÿçš„ devfsï¼Œå°†æ“ä½œç³»ç»Ÿä¸­çš„è®¾å¤‡æŠ½è±¡ä¸ºå¯ä»¥è®¿é—®çš„æ–‡ä»¶ï¼Œå¹¶ä¸ºè¿™äº›æ–‡ä»¶æä¾›è¯»å†™æ“ä½œã€‚

å®ç°å®Œæˆåï¼Œç³»ç»Ÿä¸­çš„å¤šä¸ªçº¿ç¨‹å°±èƒ½é€šè¿‡æ–‡ä»¶ç³»ç»Ÿ API è¯»å†™æ–‡ä»¶â€”â€”è‡³æ­¤æˆ‘ä»¬ç¦»ç°ä»£æ“ä½œç³»ç»Ÿå°±åªæœ‰ä¸€æ­¥ä¹‹é¥ï¼šåªéœ€ä¸ºæ¯ä¸ªçº¿ç¨‹é™„å±ä¸€ä¸ªç‹¬ç«‹çš„åœ°å€ç©ºé—´ (é€šè¿‡è™šæ‹Ÿå­˜å‚¨å®ç°ï¼Œå‚è€ƒ xv6 ä»£ç )ï¼Œçº¿ç¨‹å°±å˜æˆäº†æˆ‘ä»¬ç†ŸçŸ¥çš„è¿›ç¨‹ï¼Œæ“ä½œç³»ç»Ÿå°±å®Œæ•´äº†ã€‚

## 2. å®éªŒæè¿°

### 2.1 å®éªŒæ€»è§ˆ

è¿™ä¸ªå®éªŒåœ¨ pmm å’Œ kmt (åŒ…æ‹¬ dev) çš„åŸºç¡€ä¸Šï¼Œåœ¨ç£ç›˜è®¾å¤‡ (é©±åŠ¨ç¨‹åº) çš„åŸºç¡€ä¸Šå®ç°æŒä¹…çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”åœ¨çº¿ç¨‹çº§åˆ«æ”¯æŒæ–‡ä»¶æè¿°ç¬¦å’Œæ–‡ä»¶/ç›®å½•æ“ä½œ APIâ€”â€”vfs çš„ API å’Œå¤§å®¶åœ¨ MiniLabs ä¸­ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨å‡ ä¹å®Œå…¨ä¸€æ ·â€”â€”åœ¨ Linux ä¸­ï¼Œæˆ‘ä»¬çš„è¿›ç¨‹é€šè¿‡ syscall æŒ‡ä»¤è¿›å…¥è¿›å…¥æ“ä½œç³»ç»Ÿåå°±ä¼šç›´æ¥è°ƒç”¨è¿™äº›å‡½æ•°ã€‚

> #### æ³¨æ„ï¼šæœ¬å®éªŒéœ€è¦è®¾å¤‡é©±åŠ¨ç¨‹åºéƒ¨åˆ†æ­£å¸¸å·¥ä½œ
>
> åœ¨ Lab 3 ä¸­ï¼Œä½ éœ€è¦åˆå¹¶ Lab 2 çš„å®˜æ–¹æµ‹è¯•ç”¨ä¾‹ (dev ä»¥åŠè‹¥å¹²è®¾å¤‡é©±åŠ¨çš„å®ç°)ã€‚ä½†å³ä¾¿ä½ çš„ kmt å®ç°æœ‰é—®é¢˜ (ä¾‹å¦‚ç»ˆç«¯è®¾å¤‡åœ¨æ—¶é’Ÿä½œç”¨ä¸‹æœ‰ä¸€å®šçš„å¼‚å¸¸)ï¼Œä½ ä¹Ÿå¯ä»¥å°è¯•æ³¨é‡Šæ‰çº¿ç¨‹åˆ›å»ºçš„ä»£ç å’Œä¸­æ–­å¤„ç†ç¨‹åºçš„æ³¨å†Œï¼ŒLab 3 çš„ Online Judge åªè°ƒç”¨ç£ç›˜è®¾å¤‡ (sda)ï¼Œå…¶ä»£ç ç›¸å¯¹ç®€å•ã€‚

æˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿ API åšäº†ç›¸å½“çš„ç®€åŒ–ï¼Œä¾‹å¦‚å¹¶ä¸æ”¯æŒåŠ¨æ€çš„ mount (æ–‡ä»¶ç³»ç»Ÿåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è¢« mount)ã€‚å…·ä½“æ¥è¯´ï¼Œä½ éœ€è¦å®ç°ä»¥ä¸‹ API:

```
struct ufs_stat;
MODULE(vfs) {
  void (*init)();
  int (*write)(int fd, void *buf, int count);
  int (*read)(int fd, void *buf, int count);
  int (*close)(int fd);
  int (*open)(const char *pathname, int flags);
  int (*lseek)(int fd, int offset, int whence);
  int (*link)(const char *oldpath, const char *newpath);
  int (*unlink)(const char *pathname);
  int (*fstat)(int fd, struct ufs_stat *buf);
  int (*mkdir)(const char *pathname);
  int (*chdir)(const char *path);
  int (*dup)(int fd);
};
```

æ³¨æ„åˆ°æˆ‘ä»¬çš„æ¡†æ¶ä¸­è¿˜æä¾›äº† `framework/user.h`, è¿™ä¸ªæ–‡ä»¶æ˜¯ç”¨æˆ·è¿›ç¨‹ (å‡æƒ³æœ‰çš„è¯)/å†…æ ¸ä¹‹é—´å…±äº«çš„ï¼Œå®ƒå®šä¹‰äº†è¯¸å¦‚ `struct ufs_stat`, ä»¥åŠè‹¥å¹²å‡½æ•°å‚æ•°çš„å«ä¹‰ï¼Œå’Œç›®å½•æ–‡ä»¶çš„æ ¼å¼ã€‚ä¾‹å¦‚ `whence` ä¸­çš„ `SEEK_SET`, `SEEK_CUR` å’Œ `SEEK_END`ï¼š

```
#define T_DIR     1
#define T_FILE    2

#define SEEK_CUR  0
#define SEEK_SET  1
#define SEEK_END  2

#define O_RDONLY  00000000
#define O_WRONLY  00000001
#define O_RDWR    00000002
#define O_CREAT   00000100

struct ufs_stat {
  uint32_t id, type, size;
};

struct ufs_dirent {
  uint32_t inode;
  char name[28];
} __attribute__((packed));
```

è¯·ä¸è¦ä¿®æ”¹ä¸Šè¿°æ¡†æ¶ä¸­çš„å®šä¹‰ï¼Œä½†æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®ç»“æ„è®¾è®¡ã€çº¿ç¨‹åŒæ­¥ç­‰ä½ éƒ½å¯ä»¥è‡ªç”±å‘æŒ¥ï¼è™½ç„¶æ–‡ä»¶ç³»ç»Ÿçš„å®ç°åŸç†ç®€å•ï¼Œä½†å®ç°æ–‡ä»¶ç³»ç»Ÿçš„å·¥ä½œé‡å¤Ÿå¤§ (è€Œä¸”è¦å°å¿ƒå¤„ç†å¾ˆå¤šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œ error handling)ï¼Œè¯·ä½ åšå¥½è°ƒè¯•ä»£ç çš„å¿ƒç†å‡†å¤‡ ğŸ˜ã€‚

## 2.2 VFS (Virtual File System) æ¨¡å—

> #### âš ï¸ çº¿ç¨‹å®‰å…¨æ€§
>
> æ³¨æ„ï¼Œé™¤äº†æ¨¡å—çš„åˆå§‹åŒ– (`init`) ä¹‹å¤–ï¼Œç³»ç»Ÿä¸­åˆ›å»ºçš„çº¿ç¨‹éƒ½å¯ä»¥å¹¶å‘åœ°è®¿é—®æ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡â€”â€”ä½†æ³¨æ„æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä»½æ–‡ä»¶æè¿°ç¬¦çš„å‰¯æœ¬ã€‚

### 2.2.1 æ¨¡å—åˆå§‹åŒ–

`vfs->init()` è´Ÿè´£åˆå§‹åŒ–å¿…è¦çš„æ•°æ®ï¼Œä¾‹å¦‚æ ¹æ–‡ä»¶ç³»ç»Ÿçš„åˆ›å»ºç­‰ã€‚æˆ‘ä»¬é¢„æœŸä½ ä¼šåœ¨ `os->init()` æ—¶è°ƒç”¨ `vfs->init()`ã€‚æ•´ä¸ªç³»ç»Ÿå¯åŠ¨åªè°ƒç”¨ä¸€æ¬¡ `vfs->init()`ã€‚

### 2.2.2 ç›®å½•ç»“æ„

åœ¨ Lab 3 ä¸­ï¼Œæˆ‘ä»¬å®ç°æ ‘çŠ¶çš„ç›®å½•ç»“æ„ï¼Œä¸‰ä¸ªæ–‡ä»¶ç³»ç»Ÿå®ç°ï¼š

- é€šè¿‡ `/` è®¿é—® ufsï¼Œufs ç®¡ç†ç£ç›˜è®¾å¤‡ `sda`ã€‚ufs æ”¯æŒæ–‡ä»¶ç³»ç»Ÿå†…çš„é“¾æ¥ (linking)ï¼›
- é€šè¿‡ `/proc` å¯ä»¥è®¿é—® procfsã€‚procfs ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹ (ä¹‹åçš„è¿›ç¨‹) åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç›®å½•ä¸­å¯ä»¥æä¾›è¯¥çº¿ç¨‹ (è¿›ç¨‹) çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ä½ å¯ä»¥é€šè¿‡ `/proc/1/name` æ¥å¾—åˆ°çº¿ç¨‹çš„åå­—ï¼›
- æˆ‘ä»¬é¢„æœŸé€šè¿‡ `/dev` è®¿é—® devfsï¼Œä¾‹å¦‚é€šè¿‡ `/dev/sda` ç”¨æ–‡ä»¶ç³»ç»Ÿ API ç›´æ¥è¯»å†™ç£ç›˜ä¸Šçš„æ•°æ®ã€‚

ä½ å¯ä»¥ç†è§£ä¸ºä½ çš„ `vfs->init()` éœ€è¦å®Œæˆ `/proc` å’Œ `/dev` çš„æŒ‚è½½â€”â€”ä½†ä½ ä¸éœ€è¦å®ç° mount/unmount APIï¼Œå› æ­¤ä½ å¯ä»¥åœ¨é€‚å½“çš„æ—¶å€™ â€œç¡¬ç¼–ç â€ ä»¥å‡å°‘ä»£ç çš„å¤æ‚åº¦ã€‚æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•æ ‘çœ‹èµ·æ¥å’Œ Linux æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ (çº¢è‰²çš„èŠ‚ç‚¹è¡¨ç¤ºç›®å½•ï¼Œé»‘è‰²çš„èŠ‚ç‚¹è¡¨ç¤ºæ–‡ä»¶ï¼Œä¸‰è§’å½¢è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿ)ï¼š

![img](pics/fs-tree.png)

`vfs` æ¨¡å—ä¸­çš„ API ç”¨äºæ”¹å˜æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„å’Œç®¡ç†çº¿ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€‚

### 2.2.3 è·¯å¾„ä¸æ–‡ä»¶æè¿°ç¬¦

```
int (*chdir)(const char *path);
int (*open)(const char *pathname, int flags);
int (*close)(int fd);
```

åœ¨æˆ‘ä»¬å®ç°çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª â€œå½“å‰è·¯å¾„â€ï¼ŒæŒ‡å‘æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå­˜åœ¨çš„ç›®å½• (æˆ‘ä»¬å‡è®¾ä¸ä¼šåˆ é™¤ä»»ä½•è¿›ç¨‹çš„å½“å‰ç›®å½•ï¼Œè™½ç„¶å®é™…çš„ç³»ç»Ÿåœ¨è¿™ç§æƒ…å†µä¸‹æœ‰ defined behaviorï¼›ä½ å¯ä»¥è€ƒè™‘å¦‚ä½•å®ç°è¿™ä¸€ç‚¹)ã€‚ä¹‹åçº¿ç¨‹æ‰§è¡Œæ‰€æœ‰çš„ API (chdir, open, read, link, unlink, mkdir) æ—¶ï¼Œå¦‚è·¯å¾„ä¸æ˜¯ä»¥ `/` å¼€å¤´ï¼Œåˆ™ç›¸å¯¹äºå½“å‰è·¯å¾„è¿›è¡Œè·¯å¾„è§£æã€‚ä¾‹å¦‚ï¼Œå¦‚æœå½“å‰ç›®å½•æ˜¯ `/proc` (procfs)ï¼Œé‚£ä¹ˆ `1/name` å°±æ˜¯ä¸€ä¸ªåˆæ³•çš„è·¯å¾„ (æŒ‡å‘ `/proc/1/name`)ã€‚

- chdir æ”¹å˜å½“å‰çº¿ç¨‹çš„å½“å‰è·¯å¾„ä¸º `path`; æˆåŠŸè¿”å› 0ã€‚

- open æ‰“å¼€ `path`, å…è®¸çš„æ‰“å¼€æ–¹å¼ flags å®šä¹‰åœ¨ `user.h`:

  - `O_RDONLY`: åªè¯»ï¼›
  - `O_WRONLY`: åªå†™ï¼›
  - `O_RDWR`: å¯è¯»å¯å†™ï¼›
  - `O_CREAT`: å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºã€‚

  å¦‚æ‰“å¼€æˆåŠŸï¼Œè¿”å›ä¸€ä¸ªéè´Ÿæ•´æ•°ç¼–å·çš„æ–‡ä»¶æè¿°ç¬¦ (æœ€å°çš„æœªä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå°±åƒæˆ‘ä»¬åœ¨ Linux ä¸­è§åˆ°çš„é‚£æ ·ï¼Œæ‰“å¼€å¤±è´¥è¿”å›è´Ÿæ•°)ã€‚æ–‡ä»¶æè¿°ç¬¦æ˜¯æŒ‡å‘æ“ä½œç³»ç»Ÿå¯¹è±¡ (å…·ä½“æ¥è¯´ï¼Œåœ¨æˆ‘ä»¬çš„å®ç°é‡Œå°±æ˜¯æ–‡ä»¶) çš„æŒ‡é’ˆï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ“ä½œè®¿é—®è¿™ä¸ªå¯¹è±¡ã€‚

- close å…³é—­ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚

> #### ä¸ UNIX æ–‡ä»¶ç³»ç»Ÿçš„åŒºåˆ«
>
> æ³¨æ„å…è®¸ open ä»¥åªè¯»çš„æ–¹å¼æ‰“å¼€ç›®å½•æ–‡ä»¶ã€‚åœ¨æˆ‘ä»¬çš„ ufs ä¸­ï¼Œç›®å½•æ–‡ä»¶ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨ `struct ufs_dirent` çš„æ•°ç»„ï¼Œä»è€Œå¯ä»¥è·å¾—ç›®å½•ä¸­æ–‡ä»¶çš„åˆ—è¡¨ï¼Œä»è€Œæ— éœ€ `readdir` (`getdents`) ç³»ç»Ÿè°ƒç”¨ã€‚

### 2.2.4 ç›®å½•å’Œæ–‡ä»¶æ“ä½œ

```
int (*mkdir)(const char *pathname);
int (*link)(const char *oldpath, const char *newpath);
int (*unlink)(const char *pathname);
int (*fstat)(int fd, struct ufs_stat *buf);
```

- ç›®å½•ç®¡ç†çš„ API æ˜¯ mkdir (åˆ›å»ºç›®å½•)ã€link (åˆ›å»ºæ–‡ä»¶çš„é“¾æ¥)ã€unlink (åˆ é™¤é“¾æ¥)ï¼Œè¡Œä¸ºå’Œ Linux/æ•™ç§‘ä¹¦ä¿æŒä¸€è‡´ï¼Œæ³¨æ„è·¯å¾„åå¦‚æœä¸æ˜¯ä»¥ `/` å¼€å¤´éœ€è¦ä»¥å½“å‰çº¿ç¨‹çš„å·¥ä½œç›®å½•è¿›è¡Œç›¸å¯¹è§£æã€‚æ³¨æ„åªæœ‰ç£ç›˜ä¸ŠæŒä¹…çš„æ–‡ä»¶ç³»ç»Ÿæ”¯æŒé“¾æ¥â€”â€”ä½ ä¸éœ€è¦ä¸º procfs å’Œ devfs æ”¯æŒé“¾æ¥ã€‚
- å¯¹ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ fstat æŸ¥çœ‹æ–‡ä»¶çš„å±æ€§ï¼Œ`struct ufs_stat` å®šä¹‰åœ¨`user.h`ï¼š
  - id æ˜¯ç¼–å· (`>= 1`)ï¼›
  - type æ˜¯ `T_DIR` (ç›®å½•) æˆ– `T_FILE` (æ–‡ä»¶)ï¼Œå…¶ä»–æ•°å€¼ä¸ºéæ³•ï¼›
  - size æ˜¯æ–‡ä»¶å¤§å°çš„å­—èŠ‚æ•°ã€‚å¯¹äºç›®å½•æ–‡ä»¶ (ç›®å½•é¡¹çš„æ•°ç»„)ï¼Œå¤§å°æ€»æ˜¯ `struct ufs_dirent` å¤§å°çš„æ•´æ•°å€ã€‚

### 2.2.5 æ–‡ä»¶æè¿°ç¬¦æ“ä½œ

```
int (*write)(int fd, void *buf, int count);
int (*read)(int fd, void *buf, int count);
int (*lseek)(int fd, int offset, int whence);
int (*dup)(int fd);
```

æŠŠæ–‡ä»¶æè¿°ç¬¦çœ‹æˆæ˜¯è®¿é—®æ“ä½œç³»ç»Ÿå¯¹è±¡çš„ â€œæŒ‡é’ˆâ€ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„æ“ä½œå°±éå¸¸å®¹æ˜“ç†è§£ï¼šread, write ä¼šä»æ–‡ä»¶æè¿°ç¬¦å†…ç½®çš„æ¸¸æ ‡ (offset) ä¸­è¯»å–æ•°æ®å¹¶ç›¸åº”æ›´æ–° offset, lseek ä¼šæ”¹å˜æ¸¸æ ‡çš„ä½ç½®ï¼Œå…¶ä¸­ whence (`user.h`):

- `SEEK_CUR`: ä»å½“å‰ä½ç½®å¼€å§‹ï¼›
- `SEEK_SET`: ä»å¤´éƒ¨å¼€å§‹ï¼›
- `SEEK_END`: ä»å°¾éƒ¨å¼€å§‹ã€‚æ­¤æ—¶ `offset` ä¸º 0 å°†ä¼šè¯»åˆ° EOF (end-of-file)ã€‚

dup å¤åˆ¶ä¸€ä»½å…±äº« offset çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿”å›æœ€å°å¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™äº› API çš„è¡Œä¸ºéƒ½å’Œ Linux ä¸€è‡´ã€‚

### 2.2.6 æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿ

#### (1) ufs

> ufs æ˜¯å»ºç«‹åœ¨è®¾å¤‡ `sda` (ç£ç›˜) ä¸Šçš„æŒä¹…æ•°æ®ç»“æ„ã€‚è®¾å¤‡é©±åŠ¨æä¾›äº†å¯¹ sda çš„è¯»å†™æ“ä½œã€‚ä½ éœ€è¦æ”¯æŒåœ¨ ufs ä¸­åˆ›å»ºç›®å½•ã€æ–‡ä»¶å’Œé“¾æ¥ã€‚

ufs é»˜è®¤æŒ‚è½½åœ¨ `/`ï¼Œå³é™¤äº† `/proc` å’Œ `/dev` ä¸­çš„æ–‡ä»¶å’Œç›®å½•ä¹‹å¤–ï¼Œå…¶ä»–çš„æ–‡ä»¶å’Œç›®å½•éƒ½å±äº ufsï¼›æ³¨æ„å¦‚æœä½¿ç”¨ open æ‰“å¼€ `/` (ufs)ï¼Œå¹¶ä¸”è¯»å–å…¶ä¸­çš„ç›®å½•é¡¹ï¼Œä½ èƒ½å¤Ÿè¯»åˆ° `dev` å’Œ `proc` (ä¸¤ä¸ªç›®å½•)ï¼Œä½†å®ƒä»¬çš„ inode ç¼–å·å¹¶ä¸é‡è¦ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„å®ç°è‡ªè¡Œç¡®å®šã€‚

ä½¿ç”¨ç›®å½•ç®¡ç†/æ–‡ä»¶ç®¡ç†çš„ API å¯ä»¥ä¿®æ”¹ ufs æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„ï¼Œå¹¶ä¸”è¿™äº›ä¿®æ”¹ä¼šæœ€ç»ˆè¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šâ€”â€”ufs æ˜¯ç£ç›˜ä¸Š (`sda`) è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½ éœ€è¦å°†æ–‡ä»¶ç³»ç»Ÿè¿™ä¸€æ•°æ®ç»“æ„ï¼Œç¿»è¯‘æˆå¯¹ I/O è®¾å¤‡çš„è¯»/å†™æ“ä½œã€‚æ³¨æ„æˆ‘ä»¬çš„ dev æ¨¡å—å·²ç»å¯¹ç£ç›˜è¿›è¡Œäº†å°è£…ï¼Œå°†ç£ç›˜å°è£…æˆäº†ä¸€ä¸ªå­—èŠ‚åºåˆ—ï¼Œå¯ä»¥æ”¯æŒä»»æ„ä½ç½®çš„è¯»å†™â€”â€”è¿™å¯èƒ½ä¼šç®€åŒ–ä½ çš„ç¼–ç¨‹ï¼Œä½†è¦æ³¨æ„éå¯¹é½çš„è¯»/å†™ä¼šå¼•èµ·é¢å¤–çš„ I/O æ“ä½œâ€”â€”ä¾‹å¦‚ä½ å¸Œæœ›å†™å…¥ç£ç›˜çš„æŸä¸ªå­—èŠ‚ï¼Œå°±ä¼šå¯¼è‡´åŒ…å«è¿™ä¸ªå­—èŠ‚çš„æ•°æ®å—è¢«è¯»å–ï¼Œç„¶åå†æ¬¡è¢«å†™å…¥ã€‚é¼“åŠ±ä½ åœ¨ä½ çš„ç³»ç»Ÿä¸­å®ç°ä¸€å±‚åŸºäºæ•°æ®å— (å—å¤§å°å¯ä»¥ç”±ä½ è‡ªè¡Œå®šä¹‰ï¼Œä¾‹å¦‚ 4 KiB) çš„ç¼“å­˜ã€‚

#### (2) procfs

> procfs æ˜¯è™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸æ¶‰åŠä»»ä½•è®¾å¤‡ã€‚ä¸æ”¯æŒåœ¨ procfs ä¸­ä½¿ç”¨ vfs API åˆ›å»ºæ–‡ä»¶/ç›®å½•/é“¾æ¥ã€‚procfs ä¸­çš„ç›®å½• (`/proc` æœ¬èº«ï¼Œä»¥åŠå½¢å¦‚ `/proc/[id]` çš„ç›®å½•) éœ€è¦æ”¯æŒ fstat å’Œread æ“ä½œï¼Œèƒ½è¯»å‡ºæ­£ç¡®çš„å¤§å° (`struct ufs_stat` ä¸­çš„ `size` å­—èŠ‚æ•°)ï¼Œå’Œ `struct ufs_dirent` ç»“æ„ä½“ã€‚

procfs å¥½åƒæ˜¯ â€œæŒ‚è½½â€ åœ¨ `/proc` ä¸‹ï¼Œprocfs ä¸­çš„ç›®å½•æ˜¯æ‰€æœ‰çš„çº¿ç¨‹çš„ç¼–å·ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹åº”çš„ç›®å½•é‡Œè‡³å°‘æœ‰ä¸€ä¸ª â€œnameâ€ æ–‡ä»¶ï¼Œè¯»å–è¯¥æ–‡ä»¶å¯ä»¥å¾—åˆ°çº¿ç¨‹çš„åå­— (`kmt->create` æ—¶çš„å‚æ•°)ã€‚å› æ­¤ä½ çš„ procfs å®ç°çœ‹èµ·æ¥å°±æ˜¯ï¼š

```
/
â””â”€â”€ proc
    â”œâ”€â”€ 1
    â”‚   â””â”€â”€ name
    â”œâ”€â”€ 2
    â”‚   â””â”€â”€ name
    â”œâ”€â”€ 4
    â”‚   â””â”€â”€ name
    â”œâ”€â”€ cpuinfo
    â””â”€â”€ meminfo
```

procfs ä¸­çš„ç›®å½•å’Œæ–‡ä»¶ä¼šæ ¹æ®çº¿ç¨‹çš„åˆ›å»º/åˆ é™¤åŠ¨æ€å˜åŒ–ã€‚å› æ­¤ä½ è¦å°å¿ƒä»¥ä¸‹æƒ…å†µï¼š

- ä½¿ç”¨ open æ‰“å¼€ `/proc` åè¯»å–åˆ°äº†ç¼–å·ä¸º 10 çš„çº¿ç¨‹ï¼›
- æ‰“å¼€ `/proc/10/name` æˆåŠŸï¼›
- æ­¤æ—¶çº¿ç¨‹ç»“æŸé€€å‡ºã€‚

æ— è®ºä½ çš„ read æ˜¯è¿”å› EOF è¿˜æ˜¯ä¾ç„¶æˆåŠŸéƒ½æ˜¯åˆç†çš„ï¼›ä½†ä½ çš„æ“ä½œç³»ç»Ÿä¸èƒ½å› æ­¤ crashã€‚

#### (3) devfs

> devfs æ˜¯è™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸æ¶‰åŠä»»ä½•è®¾å¤‡ã€‚ä¸æ”¯æŒåœ¨ devfs ä¸­ä½¿ç”¨ vfs API åˆ›å»ºæ–‡ä»¶/ç›®å½•/é“¾æ¥ã€‚

devfs å¥½åƒæ˜¯ â€œæŒ‚è½½â€ åœ¨ `/dev` ä¸‹ï¼Œdevfs ä¸­è‡³å°‘éœ€è¦åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

- zero (`/dev/zero`): åªè¯»ï¼Œæ°¸è¿œè¿”å› 0 çš„åºåˆ—ï¼›
- null (`/dev/zero`): è¯»å†™ï¼Œè¯»æ°¸è¿œè¿”å› EOFï¼Œå†™æ•°æ®ç›´æ¥æˆåŠŸ (ä¸¢å¼ƒ)ï¼›
- random (`/dev/random`): åªè¯»ï¼Œè¿”å›éšæœºçš„å­—èŠ‚åºåˆ—ã€‚

åŒ procfs, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ vfs çš„ API æ‰“å¼€ã€è¯»å–ã€å†™å…¥è¿™äº›æ–‡ä»¶ã€‚

### 2.2.7 mkfs å·¥å…·

ä½ ä¸€å®šç•™æ„åˆ° `tools/mkfs.c` è¿™ä¸ªæ–‡ä»¶äº†ã€‚ä½ éœ€è¦å®ç°è¿™ä¸ª mkfs å·¥å…·ï¼Œå®ƒæ¥å—ä¸‰ä¸ªå‚æ•° size, img å’Œ dirï¼Œå°†æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›®å½• dir ä¸­çš„æ‰€æœ‰ç›®å½•å’Œæ–‡ä»¶ â€œæ‰“åŒ…â€ åˆ° img é•œåƒæ–‡ä»¶ä¸­ï¼Œå¹¶å°†é•œåƒæ–‡ä»¶çš„å¤§å°è®¾ç½®ä¸º size MiBã€‚ä¾‹å¦‚ï¼Œå‡è®¾å½“å‰ç›®å½•ä¸­æœ‰ fs-img:

```
fs-img
â”œâ”€â”€ a.txt
â”œâ”€â”€ b.txt
â””â”€â”€ t
    â””â”€â”€ tmp.txt
```

åˆ™æ‰§è¡Œ

```
mkfs 64 build/kernel-x86_64-qemu fs-img/
```

å°†ä¼šæŠŠ â€œfs-imgâ€ ä½œä¸ºä½ ç£ç›˜ä¸Šæ–‡ä»¶ç³»ç»Ÿ (æ•°æ®ç»“æ„) çš„æ ¹ (`/`)ï¼Œå†™å…¥åˆ° `build/kernel-x86_64-qemu` ä¸­ï¼Œå¹¶å°†è¯¥æ–‡ä»¶çš„å¤§å°è®¾ç½®ä¸º 64 MiBã€‚ç®€å•èµ·è§ï¼Œä½ å¯ä»¥å‡è®¾ dir ä¸­ä¸å­˜åœ¨ä»»ä½•å½¢å¼çš„é“¾æ¥ (ç¬¦å·é“¾æ¥æˆ–ç¡¬é“¾æ¥)ã€‚Online Judge ä¼šåœ¨ make ç¼–è¯‘å®Œæˆåã€æ‰§è¡Œå¼€å§‹å‰è°ƒç”¨ä½ çš„ mkfs å·¥å…·ï¼Œåˆ›å»ºåˆå§‹çš„é•œåƒï¼Œç„¶åå¼€å§‹æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿçš„ workloadsã€‚æˆ‘ä»¬åœ¨æµ‹è¯•æ—¶ï¼Œmkfs åˆ›å»ºçš„é•œåƒä¸ä¼šè¶…è¿‡ AbstractMachine ä¸­ç£ç›˜çš„å¤§å° (åœ¨å½“å‰çš„å®ç°ä¸­æ˜¯ 256 MiB)ã€‚

æ³¨æ„ AbstractMachine ç£ç›˜é•œåƒæœ‰å®ƒå›ºå®šçš„æ ¼å¼ï¼š

![img](pics/am-disk-img.png)

åªæœ‰åœ¨ kernel çš„ ELF æ–‡ä»¶ä¹‹åçš„ç©ºé—´æ‰æ˜¯å¯ç”¨çš„ã€‚ä¸ºäº†åœ¨ç£ç›˜ä¸Šå»ºç«‹æ–‡ä»¶ç³»ç»Ÿï¼Œä½ æœ‰ä¸¤ç§å¯è¡Œçš„æ–¹æ³•ï¼Œå¯ä»¥ä»»æ„é€‰æ‹©ï¼š

- æ–‡ä»¶ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ª block ä»å›ºå®šçš„ä½ç½®å¼€å§‹ï¼Œä¾‹å¦‚ 1 MiB çš„ä½ç½®ã€‚è¿™æ ·ä½ å¯èƒ½éœ€è¦æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ï¼Œåœ¨äºŒè¿›åˆ¶æ–‡ä»¶è¿‡å¤§æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚
- æ–‡ä»¶ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ª block ç”± ELF æ–‡ä»¶å†³å®šï¼Œä¾‹å¦‚ç›´æ¥åœ¨ ELF æ–‡ä»¶ä¹‹åã€‚ä½ éœ€è¦æŠŠè¿™ä¸ª block çš„ç¼–å· (ä¾‹å¦‚æ‰‡åŒºå·) å†™å…¥åˆ°ç£ç›˜çš„å¼•å¯¼æ‰‡åŒº (ç¬¬ä¸€ä¸ª 512 å­—èŠ‚) ä¸­ã€‚

### 2.2.10 å‘

ä½ ä¼šåœ¨å®ç°æ–‡ä»¶ç³»ç»Ÿçš„è¿‡ç¨‹ä¸­é‡åˆ°å„ç§å„æ ·çš„å°éº»çƒ¦ï¼Œä¾‹å¦‚ä½ é¦–å…ˆé‡åˆ°çš„å‘æ˜¯ mkfs éœ€è¦å°†æ–‡ä»¶ â€œpadâ€ åˆ°æŒ‡å®šçš„å¤§å°ï¼Œç£ç›˜æ‰èƒ½æ­£ç¡®å†™å…¥ã€‚å¦‚æœé•œåƒæ–‡ä»¶åªæœ‰ 1 MiBï¼Œé‚£ä¹ˆè¯»å–ä¹‹åçš„å­—èŠ‚éƒ½å°†å¾—åˆ° 0ã€‚ä½ è¯»åˆ°è¿™å¥è¯çš„æ—¶å€™ï¼Œå¯èƒ½é‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜å¹¶ä¸” debug å¾ˆä¹…äº†â€”â€”jyy è§‰å¾—è°ƒè¯•å’Œèµ°è¿‡çš„å¼¯è·¯éƒ½æ˜¯éå¸¸å®è´µçš„ç»éªŒã€‚

æ¯ä¸ªè¿›ç¨‹æœ‰ â€œå½“å‰è·¯å¾„â€ï¼Œé€šå¸¸æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªåˆæ³•ç›®å½• (è‡³å°‘åœ¨ chdir è¿”å›çš„ç¬é—´ï¼Œå¦åˆ™ chdir åº”è¯¥è¿”å›å¤±è´¥)ã€‚ä½†æ˜¯ï¼Œç³»ç»Ÿä¸­çš„å…¶ä»–çº¿ç¨‹ (ç”šè‡³å½“å‰çº¿ç¨‹) å¯èƒ½å°†è¿™ä¸ªç›®å½•åˆ é™¤ã€‚æ­¤æ—¶ï¼Œä½ çš„ç³»ç»Ÿçš„è¡Œä¸ºæ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœå†è€ƒè™‘åˆ° inode çš„å›æ”¶ï¼Œä½ ä¼šå‘ç°è¿™ä»¶äº‹è¿œæ¯”ä½ æƒ³è±¡å¾—å›°éš¾â€”â€”ä½ éœ€è¦éå¸¸ä»”ç»†åœ°è®¾è®¡å…¶ä¸­çš„å¯¹è±¡ç»“æ„ã€å¼•ç”¨è®¡æ•°ç­‰ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„å®ç°å¹¶ä¸åªæ˜¯ â€œç£ç›˜ä¸Šçš„æ•°æ®ç»“â€ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»æ­£ç¡®å®ç°å®ƒåœ¨å†…å­˜ä¸­çš„è§†å›¾ã€‚

ä½ ä¸å¦¨åœ¨ Linux ç³»ç»Ÿé‡Œè¯•ä¸€è¯•ï¼Œå¦‚æœå¤„äºä¸€ä¸ªè¢«åˆ é™¤çš„ç›®å½•ä¼šå‘ç”Ÿä»€ä¹ˆâ€”â€”æ— è®ºå¦‚ä½•å¯ä»¥è‚¯å®šçš„æ˜¯ï¼ŒLinux ç³»ç»Ÿä¸ä¼š crashï¼Œä½†ä½ çš„æ“ä½œç³»ç»Ÿå¯èƒ½å°±ä¼šäº†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ä¸­æ²¡æœ‰è¿™ç§æƒ…å†µâ€”â€”æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ä¸­æ‰€æœ‰çš„è®¿é—®éƒ½æ˜¯åˆæ³•çš„ã€‚åšå¯¹æ‰€æœ‰çš„ error handling æ˜¯ä¸ªæå…·æŒ‘æˆ˜çš„é—®é¢˜ï¼Œç”šè‡³ Linux Kernel éƒ½åšå¾—ä¸å¤Ÿå¥½ã€‚

æ–‡ä»¶ç³»ç»Ÿçš„ API çœ‹ä¼¼ç®€å•ï¼Œä½†å…¶å®éšå¤„éƒ½å……æ»¡äº†å„ç§å„æ ·çš„å‘ (ä¾‹å¦‚å¦‚ä½•è¿›è¡Œè·¯å¾„è§£æã€å¦‚ä½•å°†æ“ä½œè½¬å‘åˆ°å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿå®ç°ç­‰ç­‰)ã€‚åœ¨è¿™é‡Œ jyy è¦è­¦å‘Šå¤§å®¶ï¼šè¯·ç•™æ„ä½ é¡¹ç›®ä»£ç çš„ç»„ç»‡å’Œè®¾è®¡ã€‚å¦‚æœä½ ç›´æ¥ â€œä¸ç®¡ä¸€åˆ‡â€ åœ°ç¼–ç¨‹ï¼Œå¾ˆå¿«å°±ä¼šå¾—åˆ°è†¨èƒ€ä¸”éš¾ä»¥ç»´æŠ¤çš„ä»£ç ã€‚å†·é™ä¸‹æ¥è¯»ä¸€è¯» xv6 çš„ä»£ç æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

## 3. æ­£ç¡®æ€§æ ‡å‡†

### 3.1 æ–‡ä»¶ç³»ç»Ÿå®ç°

> #### æ³¨æ„ï¼šè°ƒè¯•è¾“å‡º
>
> åŒä¸Šä¸€ä¸ªå®éªŒï¼Œè¯·å°½é‡**ä¸è¦æ‰“å°å¤šä½™çš„è¾“å‡º**ã€‚è™½ç„¶æˆ‘ä»¬çš„æ£€æŸ¥ä»£ç ä¼šè¿›è¡Œä¸€å®šçš„è¿‡æ»¤ï¼Œä½†å› ä¸ºå¤šå¤„ç†å™¨çš„å¹¶å‘ï¼Œä½ åœ¨å…¶ä»–å¤„ç†å™¨ä¸Šçš„è¾“å‡ºå¯èƒ½ä¼šå½±å“æˆ‘ä»¬çš„æ£€æŸ¥è¾“å‡ºï¼Œä»è€Œå¯¼è‡´ Wrong Answerã€‚å› æ­¤æˆ‘ä»¬å»ºè®®ä½ ä½¿ç”¨è‡ªå·±çš„ log æˆ– printk å‡½æ•° (è€Œä¸æ˜¯ printf; æˆ‘ä»¬çš„æµ‹è¯•ç¨‹åºä¼šä½¿ç”¨ printf)ï¼Œä¸”å®ƒä»¬çš„è¡Œä¸ºç”±é¢„ç¼–è¯‘æŒ‡ä»¤æ§åˆ¶ï¼Œä»…åœ¨ä½ æœ¬åœ°ç¼–è¯‘æ—¶æ‰æ‰“å°æ•°æ®ã€‚

åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬ä¼šé¦–å…ˆä½¿ç”¨ä½ çš„ mkfs å·¥å…·åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åå¯åŠ¨è™šæ‹Ÿæœºã€åˆ›å»ºè‹¥å¹²çº¿ç¨‹ï¼Œè¿ç»­è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿ APIï¼Œæ ¹æ®æ–‡ä»¶ç³»ç»Ÿ API çš„è¾“å‡ºå†³å®šä½ å®ç°çš„æ­£ç¡®æ€§ã€‚åœ¨ easy tests ä¸­ï¼Œæˆ‘ä»¬åªåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œé¡ºåºåœ°æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œå¹¶æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½å®ç°ã€‚åœ¨ hard tests ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºè‹¥å¹²çº¿ç¨‹æ‰§è¡Œä¸€ç³»åˆ—çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚æ‰§è¡Œçš„æ“ä½œå¯èƒ½æœ‰ä¸€å®šçš„éšæœºæ€§ï¼Œå¹¶ä¸”å› ä¸ºå¹¶å‘ç¨‹åºçš„ä¸ç¡®å®šæ€§ï¼Œä½ å°†ä¼šé¢„æœŸæ¯æ¬¡æ‰§è¡Œçš„ç»“æœéƒ½æœ‰ä¸€äº›ä¸åŒï¼Œä½†ä½ éœ€è¦å®ç°å¯ä¸²è¡ŒåŒ– (serializable) çš„æ–‡ä»¶ç³»ç»Ÿï¼šæ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„ç»“æœçœ‹èµ·æ¥åƒæ˜¯æ‰€æœ‰æ‰§è¡Œè¿‡çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œæ’æˆæŸä¸ªé¡ºåºæ‰§è¡Œçš„ã€‚æœ€ç®€å•çš„å®ç°å¯ä¸²è¡ŒåŒ–çš„æ–¹å¼å°±æ˜¯ä¸ºæ–‡ä»¶ç³»ç»Ÿæ“ä½œåŠ ä¸Šäº’æ–¥é”ï¼Œå¯ä»¥ä½¿ç”¨ä¿¡å·é‡çš„ P/V æ“ä½œå®ç°ã€‚

> #### æ³¨æ„ï¼šä¸Šé”çš„ç²’åº¦
>
> ç£ç›˜æ˜¯æ…¢é€Ÿè®¾å¤‡ï¼›ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œå¯èƒ½è¾ƒé•¿ï¼Œä½¿ç”¨è‡ªæ—‹é”å¯èƒ½ä¼šå¯¼è‡´ä¸­æ–­ä¸¢å¤±ã€é¥¥é¥¿ç­‰åæœ (é¥¥é¥¿æ„å‘³ç€ä½ æ— æ³•è¾¾åˆ°æœ€å°çš„æ€§èƒ½è¦æ±‚ä»è€Œ Wrong Answer)ã€‚å¦‚æœä½ å¸Œæœ›å€Ÿç”¨ Lab2 ä¸­çš„åŒæ­¥åŸè¯­ï¼Œè¯·ä½¿ç”¨ä¿¡å·é‡å®ç°çš„äº’æ–¥é”ï¼Œåœ¨çº¿ç¨‹æ— æ³•è·å¾—é”æ—¶ç¡çœ ã€‚

æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹çš„æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨å‡åœ¨ä½¿ç”¨ `kmt->create` åˆ›å»ºçš„çº¿ç¨‹ä¸­è°ƒç”¨â€”â€”å› ä¸ºæ–‡ä»¶æè¿°ç¬¦æ˜¯çº¿ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨æ“ä½œç³»ç»Ÿå¯åŠ¨/åˆå§‹åŒ–/ä¸­æ–­æ—¶æ‰§è¡Œå¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œã€‚

ä¸ºäº†å°½å¯èƒ½åœ°è®©æ‰€æœ‰åŒå­¦èƒ½å®Œæˆ Lab3ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹è™½ç„¶ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œä½†çº¿ç¨‹ä¸ä¼šç»ˆæ­¢ (æ‰§è¡Œå®Œæ‰€æœ‰æ“ä½œçš„çº¿ç¨‹ä¼šæ‰§è¡Œæ­»å¾ªç¯æˆ– yield)ï¼Œä¹Ÿä¸è°ƒç”¨ä¿¡å·é‡ (ä¼šè°ƒç”¨è‡ªæ—‹é”)ï¼Œè¿™æ ·å³ä¾¿ä½ çš„ Lab2 å®ç°æœ‰ä¸€å®šé—®é¢˜ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€å®šçš„æµ‹è¯•ç”¨ä¾‹ã€‚

### 3.2 æ•°æ®çš„æŒä¹…æ€§

åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬ä¸è¦æ±‚ä½ å®ç°æ»¡è¶³å´©æºƒä¸€è‡´æ€§çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿæ²¡æœ‰æä¾› fsync çš„æ¥å£ï¼šæˆ‘ä»¬å‡è®¾ä½ çš„æ•°æ®æ»¡è¶³ â€œeventual consistencyâ€ï¼Œå³ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„åœ¨æ²¡æœ‰æ›´å¤šæ“ä½œåˆ°æ¥æ—¶ï¼Œä¼šè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚æˆ‘ä»¬çš„æµ‹è¯•æ•°æ®ä¼šåœ¨æ‰€æœ‰çš„ç£ç›˜æ“ä½œä¹‹åç­‰å¾…ä¸€ç§’é’Ÿ (1000ms)ï¼Œç„¶åå…³é—­è™šæ‹Ÿæœºã€‚å†æ¬¡é‡å¯åï¼Œufs æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ•°æ®åº”å½“è¢«æ­£ç¡®æŒä¹…åŒ–ï¼Œä¾‹å¦‚ä¹‹å‰åˆ›å»ºçš„ç›®å½•å’Œæ–‡ä»¶æ­¤æ—¶åº”è¯¥èƒ½å¤Ÿæ­£ç¡®è®¿é—®ï¼Œèƒ½è¯»å–å‡ºæ­£ç¡®çš„æ•°æ®ã€‚å¦‚æœä½ ä½¿ç”¨äº†ç±»ä¼¼ buffer cache çš„ç»“æ„å¯¹ç£ç›˜çš„è¯»å†™è¿›è¡Œäº†ç¼“å­˜ï¼Œè¯·ä½ ç¡®ä¿åœ¨åœ¨è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿè°ƒç”¨ä¹‹åçš„ 1s å†…å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚ä¾‹å¦‚ï¼š

1. ä½ å¯ä»¥é€‰æ‹©æœ€ç®€å•çš„å®ç°ï¼Œå³æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæ“ä½œéƒ½ç«‹å³å†™å…¥ç£ç›˜ï¼Œåœ¨æœ€åä¸€ä¸ªç³»ç»Ÿæ“ä½œè¿”å›æ—¶ï¼Œç£ç›˜å³å¤„äº consistent çš„çŠ¶æ€ã€‚
2. ä½ å¯ä»¥æ„å»ºè‡ªå·±çš„ç¼“å­˜ï¼Œæœ‰ä¸€ä¸ªåå°çš„ daemon (ç±»ä¼¼ jbd) å®Œæˆç£ç›˜çš„å†™å›ã€‚æˆ‘ä»¬å»ºè®®å†™å›çš„é¢‘ç‡åœ¨ 500msï¼Œè¿™æ ·æœ‰è¶³å¤Ÿçš„æ—¶é—´å°†æŒä¹…æ•°æ®å†™å…¥ç£ç›˜ (è™½ç„¶å¯¹äºå®é™…çš„ç³»ç»Ÿï¼Œå†™å›çš„é¢‘ç‡ä¼šæ›´ä½ä¸€äº›ï¼Œä»¥å‡å°‘ç£ç›˜çš„å¸¦å®½)ã€‚

## 4. å®éªŒæŒ‡å—

åœ¨å¼€å§‹å®ç°ä¹‹å‰â€”â€”å†å›é¡¾ä¸€ä¸‹è¿™å¥è¯ï¼šæ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„ã€‚æ‰€ä»¥ï¼Œå°±æŠŠå®ƒå½“æˆæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„é—®é¢˜ï¼Œç”¨ â€œæŠ½è±¡æ•°æ®ç±»å‹â€ å»è€ƒè™‘å®ƒçš„å®ç°ã€‚

### 4.1 æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼šåŸºç¡€

å®ç°æ–‡ä»¶ç³»ç»Ÿä¸­æœ€ â€œåŸºç¡€â€ çš„æ“ä½œæ˜¯ç»™å®šä¸€ä¸ªè·¯å¾„ (ç»å¯¹æˆ–ç›¸å¯¹å½“å‰çº¿ç¨‹çš„å½“å‰è·¯å¾„)ï¼Œå¯¹è·¯å¾„è¿›è¡Œè§£æï¼Œç„¶åè¿”å›ç›¸åº”çš„ inodeã€‚é“ç†çœ‹èµ·æ¥ç®€å•ï¼Œä½†å´æ¶‰åŠæ–‡ä»¶ç³»ç»Ÿçš„å„ä¸ªéƒ¨åˆ†ï¼Œä¹Ÿè®¸æœ‰äº›ç»†èŠ‚å°±æ˜¯ä½ æ²¡æœ‰è€ƒè™‘åˆ°çš„ã€‚

é¦–å…ˆï¼Œinode ä¸ä»…æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„ (é’ˆå¯¹ ufs è€Œè¨€)ï¼Œè¿˜éœ€è¦åœ¨å†…å­˜ä¸­åˆ†é…ï¼›è™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿ (ä¾‹å¦‚ procfs) è¿˜éœ€è¦ç»´æŠ¤ä¸€äº› inode ç§æœ‰çš„å†…å­˜æ•°æ® (ä¾‹å¦‚ procfs)ã€‚å¦‚ä½•ç®¡ç†è¿™äº›æ•°æ®ï¼Ÿå¦‚ä½•ç®¡ç†å†…å­˜ä¸­ inode çš„ç”Ÿå­˜å‘¨æœŸï¼Ÿä½ ç«‹å³ä¼šæƒ³åˆ°ä¸€äº›é—®é¢˜ï¼š

1. åœ¨è§£æè·¯å¾„æ—¶ï¼Œä¾‹å¦‚ `/this/is/a/very/long/path` æ—¶ï¼Œæˆ‘ä»¬ä¼šå†ç»å¤šä¸ª inode çš„è®¿é—®ï¼Œä¾‹å¦‚ `/`, `/this`, `/this/is`, ... æˆ‘ä»¬ä¼šåœ¨è¿™äº› inode ä¸Šåˆ†åˆ«æ‰§è¡Œ open æ“ä½œï¼Œç›´åˆ°ç¡®å®šè¦æ‰“å¼€çš„ inode ä¸ºæ­¢ï¼›
2. çº¿ç¨‹ (è¿›ç¨‹) æœ‰è‡ªå·±çš„ â€œå½“å‰ç›®å½•â€ï¼Œæ‰€æœ‰æ¶‰åŠè·¯å¾„çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå½“ç»™å®šçš„è·¯å¾„ä¸æ˜¯ä»¥ `/` å¼€å¤´æ—¶ï¼Œéƒ½æ˜¯ç›¸å¯¹å½“å‰è¿›ç¨‹çš„ â€œå½“å‰ç›®å½•â€ è¿›è¡Œè§£æçš„ï¼›
3. æ‰“å¼€çš„ inode ä¼šå†ç»å„ç§æ“ä½œï¼Œä¾‹å¦‚ä»æ–‡ä»¶ç³»ç»Ÿä¸­ unlinkã€‚æ­¤æ—¶å¯èƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æŒæœ‰è¯¥ inode çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”æ­£åœ¨å‘æ–‡ä»¶è¯»å†™æ•°æ®ã€‚æ­¤æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæ˜¯å¦ä¼šæœ‰ä¸€æ–¹è¿”å›å¤±è´¥ï¼Ÿè¯·ä½ åœ¨ Linux ä¸­è¯•ä¸€è¯•ã€‚

åªè¦ä½ åœ¨å†…å­˜ä¸­å®ç° `struct inode`, ä½ å°±å¿…é¡»å°å¿ƒåœ°ç®¡ç†å®ƒçš„ç”Ÿå­˜å‘¨æœŸâ€”â€”å½“çº¿ç¨‹åˆ›å»ºã€é”€æ¯ã€æ–‡ä»¶å…³é—­â€¦â€¦å„ç§æ—¶åˆ»ï¼Œä½ éƒ½è¦å°å¿ƒåœ°ç»´æŠ¤å†…å­˜ä¸­çš„ inodesï¼Œä½¿å¾—å®ƒä»¬åœ¨ä¸å†ä½¿ç”¨æ—¶ (æˆ–è€…æ˜¯åœ¨å¯ä»¥é‡Šæ”¾åä¸€æ®µæ—¶é—´å) èƒ½è¢«å®‰å…¨åœ°é‡Šæ”¾ï¼Œå¹¶ä¸”ä¸å¼•èµ· double-free, use-after-free ç­‰é—®é¢˜ã€‚å¼•ç”¨è®¡æ•°æ˜¯ä¸ªå¾ˆå¥½çš„æœºåˆ¶ï¼Œä½†ä½ å¿…é¡»è¦å°å¿ƒåœ°ç®¡ç†å¼•ç”¨â€”â€”ä¸€æ—¦æŸä¸ªå¼•ç”¨å‘ç”Ÿå¤åˆ¶æ—¶ä½ å¿˜è®°å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå°±æ„å‘³ç€ç¨‹åºé‡Œå¯èƒ½ä¼šå‡ºç°ä¸¥é‡çš„é—®é¢˜ã€‚

è·¯å¾„è§£æçš„æ ¸å¿ƒæ˜¯ç»™å®šä¸€ä¸ª inode (å‡è®¾ä½ å·²ç»è½½å…¥å†…å­˜ï¼Œå¹¶ä¸”ç¡®ä¿æ˜¯ä¸€ä¸ªç›®å½•æ–‡ä»¶)ï¼Œç„¶åè¯»å–è¿™ä¸ªç›®å½•æ–‡ä»¶ä¸­çš„ç›®å½•é¡¹ (é€šè¿‡æ–‡ä»¶ç³»ç»Ÿçš„ read æ“ä½œ)ï¼Œæ‰¾åˆ°åå­—åŒ¹é…çš„ inode ç¼–å·ï¼Œé€’å½’è¿™ä¸ªè¿‡ç¨‹å°±èƒ½å®Œæˆè·¯å¾„è§£æâ€”â€”æˆ‘ä»¬ä¹Ÿé¼“åŠ±ä½ å®ç°æˆé€’å½’çš„ï¼Œè¿™ä¼šå¤§å¤§ç®€åŒ–ä½ çš„å®ç°ã€‚

è·¯å¾„è§£æçš„å¦ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜æ˜¯å¤„ç† `/proc`, `/dev` è¿™æ ·çš„æŒ‚è½½ç‚¹ (mount point)ã€‚ä½ åº”è¯¥èƒ½æƒ³åˆ°ä¸€ä¸ªé€šç”¨çš„å®ç°æŒ‚è½½çš„æ–¹æ¡ˆï¼Œè¿™æ ·ä½ çš„æ–‡ä»¶ç³»ç»Ÿèƒ½æŒ‚è½½åˆ°ç›®å½•æ ‘çš„ä»»ä½•åœ°æ–¹â€”â€”Linux/UNIX çš„ç¡®å°±æ˜¯è¿™æ ·å®ç°çš„ã€‚

### 4.2 å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å…±å­˜

åœ¨è·¯å¾„è§£æçš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šæ„è¯†åˆ°æˆ‘ä»¬æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ â€œæ•°æ®ç»“æ„â€ éƒ½ä¸å¤ªä¸€æ ·ï¼š

1. ufs çš„æ–‡ä»¶å’Œç›®å½•éƒ½ä»¥ä¸€ä¸ªç±»ä¼¼ UNIX æ–‡ä»¶ç³»ç»Ÿçš„è®¾è®¡æ–¹å¼å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œå› æ­¤å¯¹ ufs æ–‡ä»¶å’Œç›®å½•çš„ä¿®æ”¹éœ€è¦ç¿»è¯‘æˆ `sda` è®¾å¤‡ä¸Šçš„è¯»å†™æ“ä½œï¼›
2. procfs çš„ç›®å½•æ˜¯åŠ¨æ€åˆ›å»ºçš„ (å¹¶ä¸”ä¸åœ¨æŒä¹…å­˜å‚¨ä¸Šï¼Œè€Œæ˜¯æ ¹æ®å½“å‰çš„çº¿ç¨‹)ï¼Œå› æ­¤ä½ éœ€è¦éå†ç³»ç»Ÿä¸­çš„ `struct task`ï¼Œå¹¶ä¸”å°†çº¿ç¨‹ä¿¡æ¯å†™å…¥ç¼“å†²åŒºä¸­ï¼Œç„¶åè¿”å›ç»™å¯¹ procfs çš„ readï¼›
3. devfs çš„æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„è®¾å¤‡ (å¯èƒ½æ˜¯è™šæ‹Ÿçš„ã€å¯èƒ½æ˜¯å®é™…å­˜åœ¨çš„)ï¼Œå¯¹äºå®é™…å­˜åœ¨çš„è®¾å¤‡ï¼Œä½ éœ€è¦è°ƒç”¨è®¾å¤‡çš„ read/write; è€Œå¯¹äºè™šæ‹Ÿçš„è®¾å¤‡ï¼Œä½ éœ€è¦å‘è¯»è€…æä¾›æ­£ç¡®çš„æ•°æ®ï¼Œæˆ–æ˜¯æ¨¡æ‹Ÿå‘è®¾å¤‡çš„å†™å…¥ã€‚

ä½ éœ€è¦ä¸ºæ¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„éƒ½å®ç°ä¸€å¥—æ–‡ä»¶/ç›®å½•çš„ APIâ€”â€”è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªå®éªŒæ˜¾å¾—å¤æ‚çš„åŸå› ã€‚å¦‚æœä½ ä½¿ç”¨ç´§è€¦åˆçš„æ–¹å¼å®ç°ï¼Œä½ çš„ä»£ç å¾ˆå®¹æ˜“ä¼šé™·å…¥ä¸å¯ç»´æŠ¤çš„æ³¥æ½­ï¼›ä¾‹å¦‚ä»…ä»…æ˜¯å†™ä¸€ä¸ª â€œä»£ç æ¡†æ¶â€ å°±å·²ç»åœ¨è§†è§‰ä¸Šçœ‹èµ·æ¥ä¸å¤ªå‹å¥½äº†ï¼š

```c
int vfs_write(int fd, void *buf, int count) {
  struct file *f = current->oflies[fd]; // å–å‡ºæ•°æ®ç»“æ„
  struct dev *d;
  if (!f) goto abort;
  ...
  switch (f->inode->type) {
    case FS_PROCFS:
      ...
      break;
    case FS_DEVFS:
      d = getdev(f);
      switch (d) {
        case DEV_NULL:
          ...
        case DEV_RANDOM:
          ...
        default:
          // å…¶ä»–è®¾å¤‡ï¼Œè½¬å‘ç»™è®¾å¤‡é©±åŠ¨
          ...
      }
      break;
    case FS_UFS:
      ...
      break;
  }
  ...
abort:
  ...
}
```

å› æ­¤ï¼Œåœ¨è¿™é‡Œæœ‰å¿…è¦åšä¸€ç‚¹ â€œé¢å‘å¯¹è±¡ç¼–ç¨‹â€ã€‚æˆ‘ä»¬ä¸å¦¨æŠŠ â€œæ–‡ä»¶ç³»ç»Ÿâ€ å’Œ â€œæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ (åŒ…æ‹¬ç›®å½•æ–‡ä»¶)â€ éƒ½ä»¥å¯¹è±¡çš„å½¢å¼åŒ…è£…èµ·æ¥ã€‚ä½ ç«‹å³å°±æƒ³åˆ°äº†ï¼Œæˆ‘ä»¬çš„æ¡†æ¶ä»£ç å…¶å®å·²ç»åšäº†å¾ˆå¤šé¢å‘å¯¹è±¡çš„å°è£…äº†ï¼ä¾‹å¦‚æˆ‘ä»¬çš„æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„ â€œæ¨¡å—â€ å°±æ˜¯é¢å‘å¯¹è±¡çš„ï¼Œä¸€ä¸ªæ¨¡å—å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å¦å¤–ä¸€ä¸ªå€¼å¾—å¤§å®¶å‚è€ƒçš„æ˜¯æˆ‘ä»¬å¯¹ I/O è®¾å¤‡è¿›è¡Œçš„å°è£…ï¼š

```c
typedef struct devops {
  int (*init)(device_t *dev);
  ssize_t (*read) (device_t *dev, off_t offset, void *buf, size_t count);
  ssize_t (*write)(device_t *dev, off_t offset, const void *buf, size_t count);
} devops_t;
```

ç„¶åæˆ‘ä»¬å°±èƒ½è¿›è¡Œ â€œé¢å‘å¯¹è±¡â€ çš„è°ƒç”¨äº†ï¼š

```c
d->ops->read(d, offset, buf, count) // d: pointer to struct dev
```

è¿™æ ·çš„å†™æ³•åœ¨ C++ ä¸­å¯ä»¥æ›´ç²¾ç®€ï¼Œä¾‹å¦‚ C++ çš„å¯¹è±¡è‡ªå¸¦å‡½æ•°ï¼Œå¯ä»¥çœç•¥ â€œthisâ€ çš„è°ƒç”¨ã€‚ä»¥åŠ C++ æ”¯æŒç±»çš„ç»§æ‰¿å’Œè™šå‡½æ•°â€”â€”è™šå‡½æ•°å°±æ˜¯ç”¨ç±»ä¼¼ `devops_t` å®ç°çš„ï¼æ¯ä¸ªå¯¹è±¡çš„å¤´éƒ¨éƒ½æœ‰ä¸€ä¸ªç§°ä¸º â€œvtableâ€ çš„æ•°æ®ç»“æ„ï¼ŒæŒ‡å‘äº†å®ƒè™šå‡½æ•°å®ç°çš„åœ°å€ã€‚

```c
d.read(offset, buf, count); // d: reference of a Device object
```

ä½ ä¹Ÿå¯ä»¥å¯¹æ–‡ä»¶ç³»ç»Ÿ/æ–‡ä»¶çš„æ“ä½œåšå‡ºç±»ä¼¼çš„å°è£…ï¼Œå¯ä»¥å¤§å¹…å¢åŠ ä½ ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œä½ åœ¨é˜…è¯»æ—¶ä¹Ÿæ›´å®¹æ˜“æ¢³ç†ä½ å®ç°çš„æ­£ç¡®æ€§ã€‚

### 4.3 æ–‡ä»¶ç³»ç»Ÿå®ç°

è¿™é‡Œæœ‰å¾ˆå¤šå¾®å¦™çš„å‘ (ç”šè‡³æµ‹è¯•ç”¨ä¾‹æ— æ³•å®Œæ•´åœ°è¦†ç›–åˆ°å®ƒä»¬)ã€‚ä¾‹å¦‚ï¼Œå½“ä½ éå† procfs æ—¶ï¼Œä½ éœ€è¦éå†ç³»ç»Ÿä¸­æ‰€æœ‰çš„çº¿ç¨‹ï¼›è€Œä¸æ­¤åŒæ—¶ï¼Œçº¿ç¨‹å¯èƒ½è¢«åˆ›å»º/å›æ”¶ã€‚ä¸€ä¸ªå¤æ‚ç³»ç»Ÿçš„å®ç°å¾ˆå®¹æ˜“åœ¨è¿™ç§æƒ…å†µä¸‹äº§ç”Ÿæ•°æ®ç«äº‰ (å‡ ä¹æ€»æ˜¯ bugï¼Œä¾‹å¦‚ä½ å¯èƒ½ä¼šè¯»å–ä¸€ä¸ªå°šæœªåˆå§‹åŒ–å¥½çš„çº¿ç¨‹) æˆ–æ˜¯æ­»é”ã€‚è¿™æ ·çš„é—®é¢˜åœ¨æµ‹è¯•ä¸­æ°æ°æ˜¯å¾ˆéš¾æš´éœ²çš„ï¼šä½ å¾ˆéš¾ä¼šæƒ³åˆ°æ„é€ è¿™æ ·çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥åŠå®é™…çš„ç³»ç»Ÿå¯èƒ½ä¼šåœ¨æ›´ subtle çš„æƒ…å†µä¸‹å‡ºé”™ã€‚

æˆ‘ä»¬æ— æ³•å®Œæ•´åˆ—ä¸¾ä½ æ‰€æœ‰å¯èƒ½é‡åˆ°çš„å‘â€”â€”ä½†ä½ åœ¨å®Œæˆå®éªŒçš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¸€å®šä¼šæ„Ÿå¹åšå¥½ä¸€å®šçš„è®¾è®¡æ˜¯å¤šä¹ˆé‡è¦ã€‚ä»¥åŠï¼Œæ— è®ºä½ åšäº†å¤šå°‘è®¾è®¡ï¼Œåœ¨å®é™…ä¸­éƒ½å¯èƒ½é‡åˆ°å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œä½ ä¹ŸçœŸæ­£ç†è§£äº† lockdep, AddressSanitizer/ThreadSanitizer è¿™æ ·çš„å·¥å…·å­˜åœ¨çš„å¿…è¦æ€§ã€‚æ€»ä¹‹è¿™ä¸ª â€œç¼–ç¨‹å¤§å®éªŒâ€ ä¼šè®©ä½ çœŸæ­£ä½“ä¼šä¸€äº›è®¡ç®—æœºç³»ç»Ÿè®¾è®¡/å®ç°çš„å›°éš¾ã€‚Happy hacking!

### 4.4 ç¦åˆ©

æˆ‘ä»¬ä¸ºå¤§å®¶æä¾›äº† Hard Test ç±»ä¼¼çš„ workloadï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªç›®å½•æ ‘ (å‡è®¾åˆå§‹æ—¶ï¼Œçº¿ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ä¸º `/`)ã€‚æ–‡ä»¶åœ¨ [vfs-workload.inc](https://jyywiki.cn/pages/OS/2021/labs/vfs-workload.inc)ã€‚å¤§å®¶å¯ä»¥ç›´æ¥ç¼–å†™ä¸€ä¸ª C æ–‡ä»¶ï¼Œç„¶åï¼š

```
void run_fs_test() {
#include "vfs-workload.inc"
}
```

æ¥å°† workload ç›´æ¥ç²˜è´´åˆ° C ä»£ç ä¸­ã€‚è¿™ä¹Ÿæ˜¯ä½ ä»¬ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹çš„æ–¹æ³•â€”â€”å¦‚æœä½ ä»¬å®Œæˆäº†ä¸€ä¸ªè‡ªåŠ¨çš„éšæœºæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå·¥å…·ï¼Œä½ å¯ä»¥å°†ç³»ç»Ÿè°ƒç”¨çš„åºåˆ—å†™å…¥ä¸€ä¸ª `.inc` æ–‡ä»¶ä¸­ï¼Œç„¶åå®ƒè¢« include åˆ°ä»£ç ä¸­æ‰§è¡Œã€‚åœ¨å®é™…çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬çš„ç›®å½•æ ‘ä¼šæ¯”ç»™å‡ºçš„ workload.inc ç¨å¤§ä¸€äº›ï¼Œä½†ä¸ä¼šå¤§å¤ªå¤šã€‚

åœ¨æ‰§è¡Œå®Œ workload ä¹‹åï¼Œæˆ‘ä»¬ä¼šé€’å½’åœ°éå†ç›®å½•ï¼Œå¤§è‡´çš„ä»£ç å¦‚ä¸‹ï¼š

```c
static void traverse(const char *root) {
  char *buf = pmm->alloc(sz); // asserts success
  struct ufs_stat s;

  int fd = vfs->open(strcmp(root, "") == 0 ? "/" : root, O_RDONLY), nread;
  if (fd < 0) goto release;

  vfs->fstat(fd, &s);
  if (s.type == T_DIR) {
    while ( (nread = vfs->read(fd, buf, sz)) > 0) {
      for (int offset = 0;
           offset +  sizeof(struct ufs_dirent) <= nread;
           offset += sizeof(struct ufs_dirent)) {
        struct ufs_dirent *d = (struct ufs_dirent *)(buf + offset);
        if (d->name[0] != '.') { // å°å½©è›‹ï¼šä½ è¿™ä¸‹çŸ¥é“ä¸ºä»€ä¹ˆ
                                 // Linux ä»¥ â€œ.â€ å¼€å¤´çš„æ–‡ä»¶æ˜¯éšè—æ–‡ä»¶äº†å§
          char *fname = pmm->alloc(MAX_PATH_LEN); // assert success
          sprintf(fname, "%s/%s", root, d->name);
          traverse(fname);
          pmm->free(fname);
        }
      }
    }
  }

release:
  if (fd >= 0) vfs->close(fd);
  pmm->free(buf);
}
```

æˆ‘ä»¬ä¼šè°ƒç”¨ `traverse("");` å®Œæˆç›®å½•æ ‘çš„éå†ã€‚